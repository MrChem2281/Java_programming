<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/index.css">
    <title>Управление продуктами</title>
</head>
<body>
    <div class="container">
        <h1>Управление продуктами</h1>
        
        <!-- Сообщения -->
        <div id="message"></div>
        
        <!-- Форма добавления/редактирования -->
        <div class="form-section">
            <h2 id="form-title">Добавить продукт</h2>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="form-group">
                    <label for="title">Название:</label>
                    <input type="text" id="title" required minlength="2" maxlength="100">
                </div>
                <div class="form-group">
                    <label for="cost">Стоимость:</label>
                    <input type="number" id="cost" required min="1">
                </div>
                <button type="submit" id="submit-btn">Добавить</button>
                <button type="button" id="cancel-btn" style="display: none;">Отмена</button>
            </form>
        </div>
        
        <!-- Поиск -->
        <div class="search-section">
            <input type="text" id="search-input" class="search-input" placeholder="Поиск по названию...">
            <button onclick="searchProducts()">Поиск</button>
            <button onclick="loadProducts()">Показать все</button>
        </div>
        
        <!-- Таблица продуктов -->
        <div>
            <h2>Список продуктов</h2>
            <table id="products-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Название</th>
                        <th>Стоимость</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody id="products-tbody">
                    <!-- Данные будут загружены через JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8080/products';
        let editingId = null;

        // Загрузка продуктов при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            setupForm();
        });

        // Настройка формы
        function setupForm() {
            const form = document.getElementById('product-form');
            form.addEventListener('submit', handleFormSubmit);
            
            document.getElementById('cancel-btn').addEventListener('click', resetForm);
        }

        // Загрузка всех продуктов
        async function loadProducts() {
            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error('Ошибка загрузки данных');
                
                const products = await response.json();
                displayProducts(products);
                showMessage('Данные успешно загружены', 'success');
            } catch (error) {
                showMessage('Ошибка загрузки данных: ' + error.message, 'error');
            }
        }

        // Поиск продуктов
        async function searchProducts() {
            const searchTerm = document.getElementById('search-input').value.trim();
            if (!searchTerm) {
                loadProducts();
                return;
            }

            try {
                const response = await fetch(`${API_URL}?title=${encodeURIComponent(searchTerm)}`);
                if (!response.ok) throw new Error('Ошибка поиска');
                
                const products = await response.json();
                displayProducts(products);
                showMessage(`Найдено ${products.length} продуктов`, 'success');
            } catch (error) {
                showMessage('Ошибка поиска: ' + error.message, 'error');
            }
        }

        // Отображение продуктов в таблице
        function displayProducts(products) {
            const tbody = document.getElementById('products-tbody');
            tbody.innerHTML = '';

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Продукты не найдены</td></tr>';
                return;
            }

            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.id}</td>
                    <td>${product.title}</td>
                    <td>${product.cost} руб.</td>
                    <td class="actions">
                        <button class="edit" onclick="editProduct(${product.id}, '${product.title}', ${product.cost})">Редактировать</button>
                        <button class="delete" onclick="deleteProduct(${product.id})">Удалить</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Обработка отправки формы
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const title = document.getElementById('title').value.trim();
            const cost = parseInt(document.getElementById('cost').value);
            const id = document.getElementById('product-id').value;

            const product = { title, cost };

            try {
                let response;
                if (editingId) {
                    // Редактирование
                    response = await fetch(`${API_URL}/${editingId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(product)
                    });
                } else {
                    // Добавление
                    response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(product)
                    });
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(JSON.stringify(errorData));
                }

                const savedProduct = await response.json();
                showMessage(`Продукт успешно ${editingId ? 'обновлен' : 'добавлен'}`, 'success');
                resetForm();
                loadProducts();
            } catch (error) {
                showMessage('Ошибка сохранения: ' + error.message, 'error');
            }
        }

        // Редактирование продукта
        function editProduct(id, title, cost) {
            editingId = id;
            document.getElementById('product-id').value = id;
            document.getElementById('title').value = title;
            document.getElementById('cost').value = cost;
            document.getElementById('form-title').textContent = 'Редактировать продукт';
            document.getElementById('submit-btn').textContent = 'Обновить';
            document.getElementById('cancel-btn').style.display = 'inline-block';
        }

        // Удаление продукта
        async function deleteProduct(id) {
            if (!confirm('Вы уверены, что хотите удалить этот продукт?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'DELETE'
                });

                if (!response.ok) throw new Error('Ошибка удаления');

                showMessage('Продукт успешно удален', 'success');
                loadProducts();
            } catch (error) {
                showMessage('Ошибка удаления: ' + error.message, 'error');
            }
        }

        // Сброс формы
        function resetForm() {
            editingId = null;
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('form-title').textContent = 'Добавить продукт';
            document.getElementById('submit-btn').textContent = 'Добавить';
            document.getElementById('cancel-btn').style.display = 'none';
        }

        // Показать сообщение
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
            
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html>