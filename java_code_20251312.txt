================================================== 
=== ВСЕ JAVA ФАЙЛЫ ПРОЕКТА 
================================================== 
Дата создания: 13.12.2025  1:51:33,50 
Проект: E:\My Project\Java_programming 
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\DemoApplication.java 
================================================== 
 
package com.example.demo;

import java.util.HashSet;
import java.util.Set;

import org.springframework.boot.ApplicationArguments;
import org.springframework.boot.ApplicationRunner;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.security.crypto.password.PasswordEncoder;

import com.example.demo.model.Permission;
import com.example.demo.model.Role;
import com.example.demo.model.User;
import com.example.demo.repository.PermissionRepository;
import com.example.demo.repository.RoleRepository;
import com.example.demo.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@SpringBootApplication
@RequiredArgsConstructor
public class DemoApplication implements ApplicationRunner {

    private final PasswordEncoder passwordEncoder;
    private final UserRepository userRepository;
    private final PermissionRepository permissionRepository;
    private final RoleRepository roleRepository;
    

    @Override
    public void run(ApplicationArguments args) throws Exception{
        log.info("Starting application initialization...");
        
        // Создаем базовые разрешения
        if (permissionRepository.count() == 0){
            Permission readPermission = new Permission("device", "read");
            Permission writePermission = new Permission("device", "write");
            Permission userReadPermission = new Permission("user", "read");
            
            permissionRepository.save(readPermission);
            permissionRepository.save(writePermission);
            permissionRepository.save(userReadPermission);
            
            log.info("Created default permissions: device:read, device:write, user:read");
        } else {
            log.info("Permissions already exist, skipping creation");
        }
        
        // Создаем роль пользователя
        if (roleRepository.count() == 0){
            Role userRole = new Role();
            userRole.setName("User");
            
            // Получаем созданные разрешения
            Permission deviceRead = permissionRepository.findByResourceAndOperation("device", "read");
            Permission userRead = permissionRepository.findByResourceAndOperation("user", "read");
            
            userRole.setPermissions(new HashSet<>(Set.of(deviceRead, userRead)));
            roleRepository.save(userRole);
            
            log.info("Created User role with permissions");
        } else {
            log.info("Roles already exist, skipping creation");
        }
        
        // Создаем тестового пользователя
        if(userRepository.count() == 0){
            Role userRole = roleRepository.findByName("User");
            if (userRole != null) {
                User testUser = User.builder()
                    .username("user")
                    .password(passwordEncoder.encode("user"))
                    .role(userRole)
                    .build();
                userRepository.save(testUser);
                log.info("Created test user: username='user', password='user'");
            } else {
                log.error("User role not found, cannot create test user");
            }
        } else {
            log.info("Users already exist, skipping creation");
        }
        
        log.info("Application initialization completed successfully");
    } 

    public static void main(String[] args) {
        SpringApplication.run(DemoApplication.class, args);
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\config\CorsConfig.java 
================================================== 
 
package com.example.demo.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.CorsRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class CorsConfig{

    @Bean
    public WebMvcConfigurer corsConfigurer() {
        return new WebMvcConfigurer() {

            @Override
            public void addCorsMappings(CorsRegistry registry) {
                registry.addMapping("/**")
                        .allowedOrigins("http://localhost:3000", "http://localhost:8080", "http://localhost:4200")
                        .allowedMethods("GET", "POST", "PUT", "DELETE", "OPTIONS")
                        .allowedHeaders("*")
                        .allowCredentials(true);
            }
        };
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\config\SecurityConfig.java 
================================================== 
 
package com.example.demo.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.configuration.AuthenticationConfiguration;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.core.Authentication;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

import com.example.demo.jwt.JwtAuthEntryPoint;
import com.example.demo.jwt.JwtAuthFilter;
import com.example.demo.service.AuthService;
import lombok.RequiredArgsConstructor;

@Configuration
@EnableWebSecurity
@RequiredArgsConstructor
public class SecurityConfig {

    private static final String[] ALLOWED_URLS =
    {"/swagger-ui/**", "/v3/api-docs/**", "/uploads/**"};
    private final JwtAuthFilter jFilter;
    private final JwtAuthEntryPoint jPoint;

    @Bean
    AuthenticationManager authenticationManager(
        AuthenticationConfiguration configuration
    ) throws Exception {
        return configuration.getAuthenticationManager();
    }

    @Bean
    SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception{
        http.csrf(AbstractHttpConfigurer::disable);
        http.authorizeHttpRequests(authorize -> {
            authorize.requestMatchers(ALLOWED_URLS).permitAll();
            authorize.requestMatchers("/api/auth/login").permitAll();
            authorize.requestMatchers("/api/auth/refresh").permitAll();
            authorize.requestMatchers("/api/auth/change-password").authenticated(); // Защищаем смену пароля
            authorize.requestMatchers("/api/files/upload").authenticated(); // Защищаем загрузку файлов
            authorize.anyRequest().permitAll(); // Остальное пока разрешаем
        });

        http.sessionManagement(session -> session.sessionCreationPolicy(
            SessionCreationPolicy.STATELESS
        ));
        http.exceptionHandling(exception -> exception.authenticationEntryPoint(jPoint));
        http.addFilterBefore(jFilter, UsernamePasswordAuthenticationFilter.class);

        return http.build();
    }
    
    @Bean
    static PasswordEncoder passwordEncoder(){
        return new BCryptPasswordEncoder();
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\config\WebConfig.java 
================================================== 
 
package com.example.demo.config;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {
    
    @Value("${file.upload-dir:uploads}")
    private String uploadDir;
    
    @Override
    public void addResourceHandlers(ResourceHandlerRegistry registry) {
        registry.addResourceHandler("/uploads/**")
                .addResourceLocations("file:" + uploadDir + "/");
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\controller\AuthController.java 
================================================== 
 
package com.example.demo.controller;

import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import com.example.demo.dto.LoginRequest;
import com.example.demo.dto.LoginResponse;
import com.example.demo.service.AuthService;

import lombok.RequiredArgsConstructor;

import org.apache.catalina.connector.Response;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.CookieValue;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;


@RestController
@RequestMapping("/api/auth")
@RequiredArgsConstructor
public class AuthController {
    private final AuthService authService;
    
    @PostMapping("/login")
    public ResponseEntity<LoginResponse> login(
        @CookieValue(name = "access_token" , required = false)
        String access,
        @CookieValue(name = "refresh_token", required = false)
        String refresh,
        @RequestBody LoginRequest loginRequest){
            return authService.login(loginRequest, access, refresh);

    }
    @PostMapping("/refresh")
    public ResponseEntity<LoginResponse> refresh(@CookieValue(name = "refresh_token", required = false) String refresh){
        return authService.refresh(refresh);
    }
    @PostMapping("/logout")
    public ResponseEntity<LoginResponse> access(@CookieValue(name = "access_token", required = false) String access){
        return authService.logout(access);
    }
}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\controller\DeviceController.java 
================================================== 
 
package com.example.demo.controller;

import com.example.demo.dto.DeviceDataRequest;
import com.example.demo.service.SmartHomeService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.Map;

@RestController
@RequestMapping("/api")
@RequiredArgsConstructor
public class DeviceController {
    
    private final SmartHomeService smartHomeService;
    
    @PostMapping("/devices")
    public ResponseEntity<String> receiveDeviceData(@RequestBody DeviceDataRequest request) {
        try {
            smartHomeService.processDeviceData(
                request.getDeviceId(), 
                request.getValue(), 
                request.getDataType()
            );
            return ResponseEntity.ok("Data received successfully");
        } catch (Exception e) {
            return ResponseEntity.badRequest().body("Error: " + e.getMessage());
        }
    }
    
    @PostMapping("/devices/command")
    public ResponseEntity<String> sendDeviceCommand(@RequestBody Map<String, Object> command) {
        String deviceId = (String) command.get("deviceId");
        String action = (String) command.get("action");
        Double value = (Double) command.get("value");
        
        System.out.println("Command to " + deviceId + ": " + action + " value: " + value);
        
        return ResponseEntity.ok("Command sent successfully");
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\controller\FileController.java 
================================================== 
 
package com.example.demo.controller;

import com.example.demo.service.FileStorageService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.util.Map;

@RestController
@RequestMapping("/api/files")
@RequiredArgsConstructor
public class FileController {
    
    private final FileStorageService fileStorageService;
    
    @PostMapping("/upload")
    public ResponseEntity<?> uploadFile(@RequestParam("file") MultipartFile file) {
        try {
            String fileUrl = fileStorageService.storeFile(file);
            return ResponseEntity.ok(Map.of(
                "message", "Файл успешно загружен",
                "fileUrl", fileUrl
            ));
        } catch (Exception e) {
            return ResponseEntity.badRequest().body(Map.of("error", e.getMessage()));
        }
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\controller\ProductController.java 
================================================== 
 
package com.example.demo.controller;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import org.springframework.web.bind.annotation.RestController;

import com.example.demo.model.Product;
import com.example.demo.service.ProductService;

import jakarta.validation.Valid;

import org.springframework.http.HttpStatus;
import org.springframework.http.HttpStatusCode;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.PutMapping;





@RestController
public class ProductController {

    private final ProductService productService;
    
    public ProductController(ProductService productService) {
        this.productService = productService;
    }

    // private List<Product> products=new ArrayList<>(Arrays.asList(new Product(1l, "Сок", 130)));


    @GetMapping("/products")
    public List<Product> getProducts(@RequestParam(required = false) String title) {
        
        if (title == null){
            return productService.getAll();
        }
        return productService.getByTitle(title);
    }
    
    @PostMapping("/products")
    public ResponseEntity<Product> postProducts(@RequestBody @Valid Product product) {
        return ResponseEntity.status(HttpStatus.CREATED).body(productService.create(product));
    }

    @GetMapping("/products/{id}")
    public ResponseEntity<Product> getProduct(@PathVariable Long id) {
        Product product = productService.getById(id);
        if (product!=null){
            return ResponseEntity.ok(product);
        }
        return ResponseEntity.notFound().build();
    }

    @PutMapping("/products/{id}")
    public ResponseEntity<Product> updateProduct(@PathVariable Long id, @RequestBody @Valid Product product) {
        Product edit = productService.update(id, product);
        if (edit!=null){
            return ResponseEntity.ok(edit);
        }
        return ResponseEntity.notFound().build();
    }
    
    @DeleteMapping("/products/{id}")
    public ResponseEntity<Void> deleteProduct(@PathVariable Long id){
        if (productService.deleteById(id)){
            return ResponseEntity.noContent().build();
        }
        return ResponseEntity.notFound().build();
    }
}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\controller\SmartHomeController.java 
================================================== 
 
package com.example.demo.controller;

import com.example.demo.model.ModeSettings;
import com.example.demo.model.RoomStatus;
import com.example.demo.service.SmartHomeService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

@RestController
@RequestMapping("/api")
@RequiredArgsConstructor
public class SmartHomeController {
    
    private final SmartHomeService smartHomeService;
    
    @PutMapping("/mode/settings")
    public ResponseEntity<ModeSettings> updateModeSettings(@RequestBody ModeSettings settings) {
        ModeSettings updatedSettings = smartHomeService.updateModeSettings(settings);
        return ResponseEntity.ok(updatedSettings);
    }
    
    @GetMapping("/roomstatus")
    public ResponseEntity<RoomStatus> getRoomStatus(@RequestParam Long roomId) {
        RoomStatus status = smartHomeService.getRoomStatus(roomId);
        return ResponseEntity.ok(status);
    }
    
    @GetMapping("/mode/current")
    public ResponseEntity<ModeSettings> getCurrentMode() {
        ModeSettings currentMode = smartHomeService.getCurrentMode();
        return ResponseEntity.ok(currentMode);
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\controller\StatsController.java 
================================================== 
 
package com.example.demo.controller;

import com.example.demo.service.SmartHomeService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.Map;

@RestController
@RequestMapping("/api/stats")
@RequiredArgsConstructor
public class StatsController {
    
    private final SmartHomeService smartHomeService;
    
    @GetMapping
    public ResponseEntity<Map<String, Object>> getAutomationStats() {
        return ResponseEntity.ok(smartHomeService.getAutomationStats());
    }
    
    @GetMapping("/efficiency")
    public ResponseEntity<Map<String, Object>> getEfficiency() {
        return ResponseEntity.ok(Map.of(
            "energySaved", "15%",
            "autoActions", "47",
            "comfortLevel", "92%",
            "monthlySavings", "1200 руб."
        ));
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\controller\UserController.java 
================================================== 
 
package com.example.demo.controller;

import com.example.demo.dto.ChangePasswordRequest;
import com.example.demo.service.UserService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.Map;

@RestController
@RequestMapping("/api/user")
@RequiredArgsConstructor
public class UserController {
    
    private final UserService userService;
    
    @PostMapping("/change-password")
    public ResponseEntity<?> changePassword(@RequestBody ChangePasswordRequest request) {
        try {
            userService.changePassword(request);
            return ResponseEntity.ok(Map.of("message", "Пароль успешно изменен"));
        } catch (Exception e) {
            return ResponseEntity.badRequest().body(Map.of("error", e.getMessage()));
        }
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\dto\ChangePasswordRequest.java 
================================================== 
 
package com.example.demo.dto;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;

public record ChangePasswordRequest(
    @NotBlank(message = "Текущий пароль обязателен")
    String currentPassword,
    
    @NotBlank(message = "Новый пароль обязателен")
    @Size(min = 6, message = "Новый пароль должен содержать минимум 6 символов")
    String newPassword,
    
    @NotBlank(message = "Подтверждение пароля обязательно")
    String confirmPassword
) {} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\dto\DeviceDataRequest.java 
================================================== 
 
package com.example.demo.dto;

import lombok.Data;

@Data
public class DeviceDataRequest {
    private String deviceId;
    private Double value;
    private String dataType;
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\dto\LoginRequest.java 
================================================== 
 
package com.example.demo.dto;

public record LoginRequest( String username, String password) {

}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\dto\LoginResponse.java 
================================================== 
 
package com.example.demo.dto;

public record LoginResponse(boolean islogged, String role) {

}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\dto\UserDto.java 
================================================== 
 
package com.example.demo.dto;

import java.io.Serializable;
import java.util.Set;

public record UserDto(Long id, String username, String password, String role, Set<String> permissions) implements Serializable {

}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\dto\UserLogedDto.java 
================================================== 
 
package com.example.demo.dto;

import java.util.Set;

public record UserLogedDto(String username, String role, Set<String> permissions) {

}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\enums\TokenType.java 
================================================== 
 
package com.example.demo.enums;

public enum TokenType {
    ACCESS,REFRESH
}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\exception\GlobalExceptionHandler.java 
================================================== 
 
package com.example.demo.exception;

import java.util.HashMap;
import java.util.Map;

import org.springframework.http.ResponseEntity;
import org.springframework.validation.FieldError;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;

@RestControllerAdvice
public class GlobalExceptionHandler {
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity<Map<String,String>> Resp(MethodArgumentNotValidException exception) {
        Map<String,String> errors = new HashMap<>();
        for (FieldError fe : exception.getBindingResult().getFieldErrors()) {
            errors.put(fe.getField(), fe.getDefaultMessage());
        }
        return ResponseEntity.badRequest().body(errors);
    }
}

 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\exception\ResourceNotFoundException.java 
================================================== 
 
package com.example.demo.exception;

public class ResourceNotFoundException extends RuntimeException {
    public ResourceNotFoundException(String message){
        super(message);
    }
}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\jwt\AuthenticationFilterImpl.java 
================================================== 
 
package com.example.demo.jwt;

import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;


@RequiredArgsConstructor
public class AuthenticationFilterImpl extends UsernamePasswordAuthenticationFilter{
    private final AuthenticationManager authManager;
    
    @Override
    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response)
            throws AuthenticationException {
                UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(request.getParameter("username"), request.getParameter("passsword"));
                return authManager.authenticate(authToken);
    }







}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\jwt\CookieUtil.java 
================================================== 
 
package com.example.demo.jwt;



import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpCookie;
import org.springframework.http.ResponseCookie;
import org.springframework.stereotype.Component;

@Component
public class CookieUtil {
    @Value("${jwt.access.name}")
    private String accessName;
    @Value("${jwt.refresh.name}")
    private String refreshName;

    public HttpCookie createAccessTokenCookie(String token, long duration){
        return ResponseCookie.from(accessName, token).maxAge(duration).httpOnly(true).secure(true).path("/").sameSite("none").build();

    }
    public HttpCookie deleteAccessTokenCookie(){
        return ResponseCookie.from(accessName).maxAge(0).httpOnly(true).path("/").build();
    }

    public HttpCookie createRefreshTokenCookie(String token, long duration){
        return ResponseCookie.from(refreshName, token).maxAge(duration).httpOnly(true).secure(true).path("/").sameSite("none").build();

    }
    public HttpCookie deleteRefreshTokenCookie(){
        return ResponseCookie.from(refreshName).maxAge(0).httpOnly(true).path("/").build();
    }
}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\jwt\JwtAuthEntryPoint.java 
================================================== 
 
package com.example.demo.jwt;

import java.io.IOException;
import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;

import org.hibernate.annotations.Comment;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.AuthenticationEntryPoint;
import org.springframework.stereotype.Component;

import com.fasterxml.jackson.databind.ObjectMapper;

import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
@Component
public class JwtAuthEntryPoint implements AuthenticationEntryPoint{

    @Override
    public void commence(HttpServletRequest request, HttpServletResponse response,
            AuthenticationException authException) throws IOException, ServletException {
     
        response.setContentType(MediaType.APPLICATION_JSON_VALUE);
        response.setStatus(HttpStatus.UNAUTHORIZED.value());
        final Map<String,Object> body = new HashMap<>();
        body.put("timestamp", LocalDateTime.now().toString());
        body.put("status", HttpStatus.UNAUTHORIZED.value());
        body.put("message", authException.getMessage());
        body.put("deatils",request.getServletPath());
        body.put("error", HttpStatus.UNAUTHORIZED.getReasonPhrase());

        final ObjectMapper mapper = new ObjectMapper();
        mapper.writeValue(response.getOutputStream(), body);
    }
    

}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\jwt\JwtAuthFilter.java 
================================================== 
 
package com.example.demo.jwt;

import java.io.IOException;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.web.authentication.WebAuthenticationDetailsSource;
import org.springframework.stereotype.Component;
import org.springframework.web.filter.OncePerRequestFilter;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.Cookie;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Component
@RequiredArgsConstructor
public class JwtAuthFilter extends OncePerRequestFilter {

    @Value("${jwt.access.name}")
    private String accessCookieName;
    
    private final JwtTokenProvider tokenProvider;
    private final UserDetailsService userDetailsService;

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)
            throws ServletException, IOException {

        String token = "";
        Cookie[] cookies = request.getCookies();
        
        // ЕДИНСТВЕННОЕ ИЗМЕНЕНИЕ - добавил проверку на null
        if (cookies != null) {
            for (Cookie cookie: cookies){
                if (accessCookieName.equals(cookie.getName())){
                    token = cookie.getValue();
                    log.debug("Found JWT token in cookies");
                }
            }
        } else {
            log.debug("No cookies found in request");
        }

        if(token.equals("")) {
            log.debug("No JWT token found, skipping authentication");
            filterChain.doFilter(request, response);
            return;
        }

        if(!tokenProvider.validateToken(token)){
            log.warn("Invalid JWT token");
            filterChain.doFilter(request, response);
            return;
        }

        String username = tokenProvider.getUsername(token);
        if(username == null){
            log.warn("Username not found in JWT token");
            filterChain.doFilter(request, response);
            return;
        }

        log.debug("Valid JWT token for user: {}", username);

        UserDetails user = userDetailsService.loadUserByUsername(username);
        UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(user, null, user.getAuthorities());
        authToken.setDetails(new WebAuthenticationDetailsSource().buildDetails(request));
        SecurityContextHolder.getContext().setAuthentication(authToken);
        
        log.info("User authenticated: {}", username);

        filterChain.doFilter(request, response);
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\jwt\JwtTokenProvider.java 
================================================== 
 
package com.example.demo.jwt;

import java.security.Key;
import java.time.LocalDateTime;
import java.time.ZoneOffset;
import java.time.temporal.TemporalUnit;
import java.util.Base64;
import java.util.Date;
import java.util.Map;
import java.util.function.Function;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Service;

import com.example.demo.enums.TokenType;
import com.example.demo.model.Token;

import io.jsonwebtoken.Claims;
import io.jsonwebtoken.JwtException;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import io.jsonwebtoken.security.Keys;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
@RequiredArgsConstructor

public class JwtTokenProvider {
    @Value("${jwt.secret}")
    private String secret;

    public Token generateAccessToken(Map<String,Object> extraClaims, long duration, TemporalUnit durationType, UserDetails user){
        LocalDateTime now = LocalDateTime.now();
        LocalDateTime expiryData = now.plus(duration, durationType);
        String token = Jwts.builder().setClaims(extraClaims)
        .setSubject(user.getUsername())
        .setIssuedAt(toDate(now))
        .setExpiration(toDate(expiryData))
        .signWith(decodeSecretKey(secret), SignatureAlgorithm.HS256).compact();

        log.info("Generated ACCESS token for user: {}, expires: {}", user.getUsername(), expiryData);

        return new Token(TokenType.ACCESS, token, expiryData, false, null);
    }
     public Token generateRefreshToken(long duration, TemporalUnit durationType, UserDetails user){
        
        LocalDateTime now = LocalDateTime.now();
        LocalDateTime expiryData = now.plus(duration, durationType);
        String token = Jwts.builder()
        .setSubject(user.getUsername())
        .setIssuedAt(toDate(now))
        .setExpiration(toDate(expiryData))
        .signWith(decodeSecretKey(secret), SignatureAlgorithm.HS256).compact();

        log.info("Generated REFRESH token for user: {}, expires: {}", user.getUsername(), expiryData);

        return new Token(TokenType.REFRESH, token, expiryData, false, null);
    }

    public LocalDateTime getExpiryDate(String token){
        return toLocalDateTime(extractClaim(token, Claims::getExpiration));
    }

    private LocalDateTime toLocalDateTime(Date date){
        return date.toInstant().atOffset(ZoneOffset.UTC).toLocalDateTime();

    }

    private <T> T extractClaim(String token, Function<Claims, T> claimsResolver){
        return claimsResolver.apply(extractAllClaims(token));
    }
    
    public String getUsername(String token){
        try {
            String username = extractClaim(token, Claims::getSubject);
            log.debug("Extracted username from token: {}", username);
            return username;
        } catch (Exception e) {
            log.error("Error extracting username from token: {}", e.getMessage());
            return null;
        }
    }

    public boolean validateToken(String token){
        if(token == null) return false;
        try{
            Jwts.parserBuilder().setSigningKey(decodeSecretKey(secret)).build().parseClaimsJws(token);
            log.debug("Token validation successful");
            return true;
        }
        catch (JwtException ex){
            log.warn("Token validation failed: {}", ex.getMessage());
            return false;
        }
    }

    private Claims extractAllClaims(String token){
        return Jwts.parserBuilder().setSigningKey(decodeSecretKey(secret)).build().parseClaimsJwt(token).getBody();
    }


    private Key decodeSecretKey(String secret){
        try {
            byte[] decodeKey = Base64.getDecoder().decode(secret);
            return Keys.hmacShaKeyFor(decodeKey);
        } catch (IllegalArgumentException e) {
            log.error("Error decoding secret key: {}", e.getMessage());
            return Keys.hmacShaKeyFor(secret.getBytes());
        }
    }
    private Date toDate(LocalDateTime time){
        return Date.from(time.toInstant(ZoneOffset.UTC));
    }
}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\mapper\UserMapper.java 
================================================== 
 
package com.example.demo.mapper;

import java.util.Collections;
import java.util.stream.Collectors;

import com.example.demo.dto.UserDto;
import com.example.demo.dto.UserLogedDto;
import com.example.demo.model.Permission;
import com.example.demo.model.User;

public class UserMapper{
    public static UserDto userToUserDto(User user) {
        return new UserDto(
            user.getId(),
            user.getUsername(),
            user.getPassword(),
            user.getRole().getAuthority(),
            user.getRole().getPermissions().stream().map(Permission::getAuthority).collect(Collectors.toSet()));
    }

    public static UserLogedDto userToUserLogedDto(User user) {
        return new UserLogedDto(
            user.getUsername(),
            user.getRole().getAuthority(),
            user.getRole().getPermissions().stream().map(Permission::getAuthority).collect(Collectors.toSet()));
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\model\Device.java 
================================================== 
 
package com.example.demo.model;

import jakarta.persistence.*;
import lombok.Data;

@Entity
@Data
public class Device {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    private DeviceType type;
    private String deviceId; // Уникальный ID IoT устройства
    
    @ManyToOne
    @JoinColumn(name = "room_id")
    private Room room;
    
    private boolean isOnline;
    private Double lastValue;
    
    public enum DeviceType {
        TEMPERATURE_SENSOR,
        HUMIDITY_SENSOR, 
        LIGHT_SENSOR,      
        MOTION_SENSOR,     
        LIGHT,
        AIR_CONDITIONER,
        HEATER,            
        MUSIC_PLAYER,
        TV,
        CURTAIN,
        DEHUMIDIFIER,      
        HUMIDIFIER,        
        COFFEE_MAKER       
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\model\DeviceData.java 
================================================== 
 
package com.example.demo.model;

import jakarta.persistence.*;
import lombok.Data;
import java.time.LocalDateTime;

@Entity
@Data
public class DeviceData {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @ManyToOne
    @JoinColumn(name = "device_id")
    private Device device;
    
    private Double value;
    private LocalDateTime timestamp;
    
    private String dataType; // "temperature", "humidity", "state", etc.
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\model\ModeSettings.java 
================================================== 
 
package com.example.demo.model;

import jakarta.persistence.*;
import lombok.Data;
import lombok.NoArgsConstructor;
import lombok.AllArgsConstructor;

@Entity
@Data
@NoArgsConstructor
@AllArgsConstructor
public class ModeSettings {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String modeName; // "auto", "manual", "eco", "comfort"
    
    // Настройки температуры
    private Double targetTemperature;
    private Double temperatureThreshold;
    
    // Настройки освещения
    private Integer targetLightLevel;
    private boolean autoLightControl;
    
    // Настройки развлечений
    private boolean autoEntertainment;
    private String preferredMusicGenre;
    
    // Расписание
    private String schedule; // JSON с расписанием
    
    // Конструктор для быстрого создания
    public ModeSettings(String modeName, Double targetTemperature, boolean autoLightControl) {
        this.modeName = modeName;
        this.targetTemperature = targetTemperature;
        this.autoLightControl = autoLightControl;
        this.temperatureThreshold = 1.0;
        this.autoEntertainment = false;
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\model\Permission.java 
================================================== 
 
package com.example.demo.model;

import java.util.Set;

import org.springframework.security.core.GrantedAuthority;

import jakarta.annotation.Generated;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.IdClass;
import jakarta.persistence.ManyToMany;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Entity
@Data
@NoArgsConstructor
@AllArgsConstructor

public class Permission implements GrantedAuthority {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String resource;
    private String operation;
    
    @ManyToMany(mappedBy = "permissions")
    private Set<Role> roles;
    
    
    @Override
    public String getAuthority(){
        return String.format("%s:%s", resource.toUpperCase(), operation.toUpperCase());
    }


    public Permission(String string, String string2) {
        this.resource = string;
        this.operation = string2;
    }
}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\model\Product.java 
================================================== 
 
package com.example.demo.model;

import org.hibernate.annotations.Collate;

import jakarta.persistence.Column;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.validation.constraints.Min;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Size;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@AllArgsConstructor
@NoArgsConstructor
@Data
@Entity
public class Product {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @NotBlank
    @Column(nullable = false, unique = true, length = 100)
    @Size(min = 2, max = 100)
    private String title;

    @Column(nullable = false)
    @Min(1)
    private int cost;
}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\model\Role.java 
================================================== 
 
package com.example.demo.model;


import java.util.Set;

import org.springframework.security.core.GrantedAuthority;

import jakarta.persistence.Entity;
import jakarta.persistence.FetchType;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.JoinColumn;
import jakarta.persistence.JoinTable;
import jakarta.persistence.ManyToMany;
import jakarta.persistence.OneToMany;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Entity
@Data
@NoArgsConstructor
@AllArgsConstructor

public class Role implements GrantedAuthority {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String name;
    @OneToMany(mappedBy = "role")
    private Set<User> users;
    @ManyToMany(fetch = FetchType.EAGER)
    @JoinTable(name = "role_permission", joinColumns = @JoinColumn(name = "role_id"), inverseJoinColumns = @JoinColumn(name = "permission_id"))
    private Set<Permission> permissions;
    @Override
    public String getAuthority() {
        return name.toUpperCase();
    }


    
}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\model\Room.java 
================================================== 
 
package com.example.demo.model;

import jakarta.persistence.*;
import lombok.Data;
import java.util.ArrayList;
import java.util.List;

@Entity
@Data
public class Room {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    private String name;
    private RoomType type;
    
    @OneToMany(mappedBy = "room", cascade = CascadeType.ALL)
    private List<Device> devices = new ArrayList<>();
    
    public enum RoomType {
        LIVING_ROOM, BEDROOM, KITCHEN, BATHROOM, STUDY
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\model\RoomStatus.java 
================================================== 
 
package com.example.demo.model;

import lombok.Data;
import java.util.Map;
import java.util.HashMap;

@Data
public class RoomStatus {
    private Long roomId;
    private String roomName;
    private Map<String, Object> deviceStatus = new HashMap<>();
    private Map<String, Double> sensorData = new HashMap<>();
    private String currentMode; 
    private boolean isOccupied;
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\model\Token.java 
================================================== 
 
package com.example.demo.model;

import java.time.LocalDateTime;



import com.example.demo.enums.TokenType;

import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.ManyToOne;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

@Entity
@Data
@NoArgsConstructor
@AllArgsConstructor
public class Token {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private TokenType type;
    private String value;
    private LocalDateTime expiringDateTime;
    private boolean disabled;

    @ManyToOne
    private User user;

    public Token(TokenType type, String value, LocalDateTime eypingDateTime, boolean disabled, User user) {
        this.type = type;
        this.value = value;
        this.expiringDateTime = eypingDateTime;
        this.disabled = disabled;
        this.user = user;
    }
}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\model\User.java 
================================================== 
 
package com.example.demo.model;

import java.util.Collection;
import java.util.HashSet;
import java.util.Set;
import java.util.stream.Collector;
import java.util.stream.Collectors;

import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import jakarta.annotation.Generated;
import jakarta.persistence.Entity;
import jakarta.persistence.GeneratedValue;
import jakarta.persistence.GenerationType;
import jakarta.persistence.Id;
import jakarta.persistence.ManyToOne;
import jakarta.persistence.OneToMany;
import jakarta.persistence.Table;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;



@Builder
@Entity
@Data
@NoArgsConstructor
@AllArgsConstructor
@Table(name = "users")
public class User implements UserDetails {
    
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    private String username;
    private String password;

    @ManyToOne
    private Role role;


    @OneToMany(mappedBy = "user")
    private Set<Token> tokens;


    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        Set<String> authorities = new HashSet<>();
        role.getPermissions().forEach(p -> authorities.add(p.getAuthority()));
        authorities.add(role.getAuthority());
        return authorities.stream().map(SimpleGrantedAuthority::new).collect(Collectors.toSet());
    }
    
}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\repository\DeviceDataRepository.java 
================================================== 
 
package com.example.demo.repository;

import com.example.demo.model.DeviceData;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import java.util.List;

@Repository
public interface DeviceDataRepository extends JpaRepository<DeviceData, Long> {
    List<DeviceData> findByDeviceIdOrderByTimestampDesc(Long deviceId);
    DeviceData findTopByDeviceIdOrderByTimestampDesc(Long deviceId);
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\repository\DeviceRepository.java 
================================================== 
 
package com.example.demo.repository;

import com.example.demo.model.Device;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;
import java.util.List;

@Repository
public interface DeviceRepository extends JpaRepository<Device, Long> {
    List<Device> findByRoomId(Long roomId);
    Device findByDeviceId(String deviceId);
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\repository\ModeSettingsRepository.java 
================================================== 
 
package com.example.demo.repository;

import com.example.demo.model.ModeSettings;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface ModeSettingsRepository extends JpaRepository<ModeSettings, Long> {
    ModeSettings findByModeName(String modeName);
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\repository\PermissionRepository.java 
================================================== 
 
package com.example.demo.repository;


import org.springframework.data.jpa.repository.JpaRepository;

import com.example.demo.model.Permission;

public interface PermissionRepository extends JpaRepository<Permission, Long>{
    Permission findByResourceAndOperation(String string, String string2);
}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\repository\ProductRepository.java 
================================================== 
 
package com.example.demo.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import com.example.demo.model.Product;
import java.util.List;

@Repository
public interface ProductRepository extends JpaRepository<Product, Long> {
    List<Product> findByTitleStartingWithIgnoreCase(String title);
}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\repository\RoleRepository.java 
================================================== 
 
package com.example.demo.repository;

import java.security.Permission;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import com.example.demo.model.Role;

@Repository
public interface RoleRepository  extends JpaRepository<Role, Long>{

    Role findByName(String name);
    
}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\repository\RoomRepository.java 
================================================== 
 
package com.example.demo.repository;

import com.example.demo.model.Room;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface RoomRepository extends JpaRepository<Room, Long> {
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\repository\TokenRepository.java 
================================================== 
 
package com.example.demo.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import com.example.demo.model.Token;

@Repository
public interface TokenRepository extends JpaRepository<Token, Long> {
    
}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\repository\UserRepository.java 
================================================== 
 
package com.example.demo.repository;

import java.util.Optional;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

import com.example.demo.model.User;

@Repository
public interface UserRepository extends JpaRepository<User, Long>{
    Optional<User> findByUsername(String username);
}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\service\AuthService.java 
================================================== 
 
package com.example.demo.service;

import java.time.LocalDateTime;
import java.time.temporal.ChronoUnit;
import java.util.Map;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpHeaders;
import org.springframework.http.ResponseEntity;
import org.springframework.security.authentication.AnonymousAuthenticationToken;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContext;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Service;
import org.springframework.web.bind.annotation.CookieValue;
import org.springframework.web.bind.annotation.PostMapping;

import com.example.demo.dto.LoginRequest;
import com.example.demo.dto.LoginResponse;
import com.example.demo.dto.UserDto;
import com.example.demo.dto.UserLogedDto;
import com.example.demo.jwt.CookieUtil;
import com.example.demo.jwt.JwtTokenProvider;
import com.example.demo.mapper.UserMapper;
import com.example.demo.model.Token;
import com.example.demo.model.User;
import com.example.demo.repository.TokenRepository;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@RequiredArgsConstructor
@Service
public class AuthService {
     @Value("${jwt.access.duration.second}")
    private long accessTokenDurationSecond;
     @Value("${jwt.access.duration.minute}")
    private long accessTokenDurationMinute;

    @Value("${jwt.refresh.duration.second}")
    private long refreshTokenDurationSecond;
    @Value("${jwt.refresh.duration.day}")
    private long refreshTokenDurationDay;


    private final UserService userService;
    private final TokenRepository tokenRepository;
    private final JwtTokenProvider tokenProvider;
    private final CookieUtil cookieUtil;
    private final AuthenticationManager authenticationManager;


    private void addAccessTokenCookie(HttpHeaders headers, Token token){
        headers.add(HttpHeaders.SET_COOKIE,cookieUtil.createAccessTokenCookie(token.getValue(),accessTokenDurationSecond).toString());
    }
    private void addRefreshTokenCookie(HttpHeaders headers, Token token){
        headers.add(HttpHeaders.SET_COOKIE,cookieUtil.createRefreshTokenCookie(token.getValue(),refreshTokenDurationSecond).toString());
    }
    private void revokeAllTokensOfUser(User user){
        log.info("Revoking all tokens for user: {}", user.getUsername());
        user.getTokens().forEach(t -> {
            if (t.getExpiringDateTime().isBefore(LocalDateTime.now()))
                tokenRepository.delete(t);
            else if (t.isDisabled()) {
                t.setDisabled(true);
                tokenRepository.save(t);
            }
        });
    }
    public ResponseEntity<LoginResponse> login(LoginRequest request, String access, String refresh){
        log.info("Login attempt for user: {}", request.username());
        Authentication authentication = authenticationManager.authenticate(
            new UsernamePasswordAuthenticationToken(request.username(), request.password()));
        
            String username = request.username();
            User user = userService.getByUsername(username);
            boolean accessTokenValid = tokenProvider.validateToken(access);
            boolean refreshTokenValid = tokenProvider.validateToken(refresh);
            log.debug("Token validation - Access: {}, Refresh: {}", accessTokenValid, refreshTokenValid);
            HttpHeaders headers = new HttpHeaders();
            Token newAccess, newRefresh;
            revokeAllTokensOfUser(user);
            if (!accessTokenValid){
                newAccess = tokenProvider.generateAccessToken(
                    Map.of("role", user.getRole().getAuthority()),
                    accessTokenDurationMinute, ChronoUnit.MINUTES, user);
                newAccess.setUser(user);
                addAccessTokenCookie(headers, newAccess);
                log.debug("New access token generated for user: {}", username);
            }

            if (!refreshTokenValid || accessTokenValid){
                newRefresh = tokenProvider.generateRefreshToken(refreshTokenDurationDay, ChronoUnit.DAYS, user);
                newRefresh.setUser(user);
                addRefreshTokenCookie(headers, newRefresh);
                tokenRepository.save(newRefresh);
                log.debug("New refresh token generated for user: {}", username);
            }
            SecurityContextHolder.getContext().setAuthentication(authentication);
            log.info("User {} successfully logged in", username);
            return ResponseEntity.ok().headers(headers).body(new LoginResponse(true, user.getRole().getName()));
    }
    public ResponseEntity<LoginResponse> refresh(String refreshToken){
        log.info("Token refresh request");
        if(!tokenProvider.validateToken(refreshToken)) {
            log.warn("Refresh token validation failed");
            throw new  RuntimeException("Token is invalid");
        }
        User user = userService.getByUsername(tokenProvider.getUsername(refreshToken));
        HttpHeaders headers = new HttpHeaders();
        Token newAccess = tokenProvider.generateAccessToken(Map.of("role",user.getRole().getAuthority()), accessTokenDurationMinute,ChronoUnit.MINUTES,user);
        addAccessTokenCookie(headers, newAccess);
        log.info("Token refreshed for user: {}", user.getUsername());
        return ResponseEntity.ok().headers(headers).body(new LoginResponse(true, user.getRole().getName()));
    }
    public  ResponseEntity<LoginResponse> logout(String access){
        log.info("Logout request");
        SecurityContextHolder.clearContext();
        User user = userService.getByUsername(tokenProvider.getUsername(access));
        revokeAllTokensOfUser(user);
        HttpHeaders headers = new HttpHeaders();
        headers.add(HttpHeaders.SET_COOKIE, cookieUtil.deleteAccessTokenCookie().toString());
        headers.add(HttpHeaders.SET_COOKIE, cookieUtil.deleteRefreshTokenCookie().toString());
        log.info("User {} successfully logged out", user.getUsername());
        return ResponseEntity.ok().headers(headers).body(new LoginResponse(false,null));

    }
    public UserLogedDto getInfo(){
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if(authentication instanceof AnonymousAuthenticationToken) {
            log.warn("Anonymous user attempted to get info");
            throw new RuntimeException("anonymous user");
        }
        User user = userService.getByUsername(authentication.getName());
        log.debug("User info requested for: {}", user.getUsername());
        return UserMapper.userToUserLogedDto(user);
    }
//     @PostMapping
//     public ResponseEntity<LoginResponse> refresh(@CookieValue(name = "refresh_token", inequired = false), String refresh){
//         return authService
//     }
}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\service\AutomationService.java 
================================================== 
 
package com.example.demo.service;

import com.example.demo.model.Device;
import com.example.demo.model.ModeSettings;
import com.example.demo.repository.DeviceRepository;
import com.example.demo.repository.ModeSettingsRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.time.LocalTime;
import java.util.List;
import java.util.stream.Collectors;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Service
@RequiredArgsConstructor
public class AutomationService {
    
    private final DeviceRepository deviceRepository;
    private final ModeSettingsRepository modeSettingsRepository;
    
    public void processAutomation(Device triggeredDevice, Double value) {
        log.info("Automation triggered by {}: {}", triggeredDevice.getName(), value);
        ModeSettings currentMode = modeSettingsRepository.findById(1L).orElse(null);
        if (currentMode == null || !"auto".equals(currentMode.getModeName())) {
            log.debug("Automation skipped - mode not auto or not found");
            return;
        }
        
        // Основная логика автоматизации
        switch (triggeredDevice.getType()) {
            case TEMPERATURE_SENSOR:
                log.debug("Temperature automation for: {}°C", value);
                controlTemperature(value, currentMode);
                break;
            case HUMIDITY_SENSOR:
                log.debug("Humidity automation for: {}%", value);
                controlHumidity(value);
                break;
            case LIGHT_SENSOR:
                log.debug("Light automation for: {} lux", value);
                controlLighting(value, currentMode);
                break;
            case MOTION_SENSOR:
                log.debug("Motion detected: {}", value);
                controlMotion(value);
                break;
            default:
                log.debug("No automation for device type: {}", triggeredDevice.getType());    
        }
        
        // Дополнительная логика по времени суток
        applyTimeBasedAutomation(currentMode);
    }
    
    private void controlTemperature(Double currentTemp, ModeSettings settings) {
        Double targetTemp = settings.getTargetTemperature();
        Double threshold = settings.getTemperatureThreshold();
        
        List<Device> acDevices = getDevicesByType(Device.DeviceType.AIR_CONDITIONER);
        List<Device> heaterDevices = getDevicesByType(Device.DeviceType.HEATER);
        
        if (currentTemp > targetTemp + threshold) {
            // Жарко - включаем кондиционер, выключаем обогреватель
            sendCommandToDevices(acDevices, "COOL", 1.0);
            sendCommandToDevices(heaterDevices, "OFF", 0.0);
        } else if (currentTemp < targetTemp - threshold) {
            // Холодно - включаем обогреватель, выключаем кондиционер
            sendCommandToDevices(heaterDevices, "HEAT", 1.0);
            sendCommandToDevices(acDevices, "OFF", 0.0);
        } else {
            // Комфортная температура - выключаем всё
            sendCommandToDevices(acDevices, "OFF", 0.0);
            sendCommandToDevices(heaterDevices, "OFF", 0.0);
        }
    }
    
    private void controlHumidity(Double humidity) {
        if (humidity > 70) {
            // Высокая влажность - включаем осушитель
            List<Device> dehumidifiers = getDevicesByName("осушитель");
            sendCommandToDevices(dehumidifiers, "ON", 1.0);
        } else if (humidity < 30) {
            // Низкая влажность - включаем увлажнитель
            List<Device> humidifiers = getDevicesByName("увлажнитель");
            sendCommandToDevices(humidifiers, "ON", 1.0);
        }
    }
    
    private void controlLighting(Double lightLevel, ModeSettings settings) {
        if (!settings.isAutoLightControl()) return;
        
        List<Device> lights = getDevicesByType(Device.DeviceType.LIGHT);
        
        // Если слишком темно и вечернее время - включаем свет
        LocalTime now = LocalTime.now();
        boolean isEvening = now.isAfter(LocalTime.of(18, 0)) || now.isBefore(LocalTime.of(6, 0));
        
        if (lightLevel < 50 && isEvening) {
            sendCommandToDevices(lights, "ON", 0.7); // 70% яркости
        } else if (lightLevel > 200 || !isEvening) {
            sendCommandToDevices(lights, "OFF", 0.0);
        }
    }
    
    private void controlMotion(Double motionValue) {
        // motionValue = 1 - движение detected, 0 - нет движения
        if (motionValue == 1.0) {
            // Обнаружено движение - включаем свет в коридоре
            List<Device> corridorLights = getDevicesByRoom("Коридор");
            sendCommandToDevices(corridorLights, "ON", 0.5);
        }
    }
    
    private void applyTimeBasedAutomation(ModeSettings settings) {
        LocalTime now = LocalTime.now();
        
        // Ночной режим (23:00 - 07:00)
        if (now.isAfter(LocalTime.of(23, 0)) || now.isBefore(LocalTime.of(7, 0))) {
            applyNightMode();
        }
        
        // Утренний режим (07:00 - 09:00)
        else if (now.isAfter(LocalTime.of(7, 0)) && now.isBefore(LocalTime.of(9, 0))) {
            applyMorningMode();
        }
        
        // Режим дня когда никого нет (09:00 - 17:00)
        else if (now.isAfter(LocalTime.of(9, 0)) && now.isBefore(LocalTime.of(17, 0))) {
            applyAwayMode();
        }
    }
    
    private void applyNightMode() {
        // Выключаем весь свет кроме ночника
        List<Device> mainLights = getDevicesByType(Device.DeviceType.LIGHT);
        Device nightLight = getDeviceByName("Ночник");
        
        sendCommandToDevices(mainLights, "OFF", 0.0);
        if (nightLight != null) {
            sendCommand(nightLight.getDeviceId(), "ON", 0.2); // 20% яркости
        }
        
        // Устанавливаем комфортную температуру для сна
        List<Device> acDevices = getDevicesByType(Device.DeviceType.AIR_CONDITIONER);
        sendCommandToDevices(acDevices, "AUTO", 0.5);
    }
    
    private void applyMorningMode() {
        // Плавно включаем свет, готовим кофе
        List<Device> bedroomLights = getDevicesByRoom("Спальня");
        sendCommandToDevices(bedroomLights, "ON", 0.3);
        
        Device coffeeMaker = getDeviceByName("Кофеварка");
        if (coffeeMaker != null) {
            sendCommand(coffeeMaker.getDeviceId(), "ON", 1.0);
        }
    }
    
    private void applyAwayMode() {
        // Экономим энергию когда никого нет дома
        List<Device> lights = getDevicesByType(Device.DeviceType.LIGHT);
        sendCommandToDevices(lights, "OFF", 0.0);
        
        // Устанавливаем экономную температуру
        List<Device> acDevices = getDevicesByType(Device.DeviceType.AIR_CONDITIONER);
        sendCommandToDevices(acDevices, "ECO", 0.3);
    }
    
    // Вспомогательные методы
    private List<Device> getDevicesByType(Device.DeviceType type) {
        return deviceRepository.findAll().stream()
                .filter(d -> d.getType() == type)
                .collect(Collectors.toList());
    }
    
    private List<Device> getDevicesByName(String name) {
        return deviceRepository.findAll().stream()
                .filter(d -> d.getName().toLowerCase().contains(name.toLowerCase()))
                .collect(Collectors.toList());
    }
    
    private List<Device> getDevicesByRoom(String roomName) {
        return deviceRepository.findAll().stream()
                .filter(d -> d.getRoom() != null && roomName.equals(d.getRoom().getName()))
                .collect(Collectors.toList());
    }
    
    private Device getDeviceByName(String name) {
        return deviceRepository.findAll().stream()
                .filter(d -> name.equals(d.getName()))
                .findFirst()
                .orElse(null);
    }
    
    private void sendCommandToDevices(List<Device> devices, String command, Double value) {
        devices.forEach(device -> sendCommand(device.getDeviceId(), command, value));
    }
    
    private void sendCommand(String deviceId, String command, Double value) {
        log.info("🚀 [{}] Command to {}: {} value: {}", 
                 LocalDateTime.now(), deviceId, command, value);
        System.out.println("🚀 [" + LocalDateTime.now() + "] Command to " + deviceId + ": " + command + " value: " + value);
        
        Device device = deviceRepository.findByDeviceId(deviceId);
        if (device != null) {
            device.setLastValue(value);
            deviceRepository.save(device);
            log.debug("Device {} state updated to value: {}", deviceId, value);
        } else {
            log.warn("Device not found for command: {}", deviceId);
        }
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\service\FileStorageService.java 
================================================== 
 
package com.example.demo.service;

import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardCopyOption;
import java.util.UUID;

@Slf4j
@Service
public class FileStorageService {
    
    @Value("${file.upload-dir:uploads}")
    private String uploadDir;
    
    public String storeFile(MultipartFile file) {
        try {
            // Создаем директорию если не существует
            Path uploadPath = Paths.get(uploadDir);
            if (!Files.exists(uploadPath)) {
                Files.createDirectories(uploadPath);
            }
            
            // Проверяем тип файла (опционально)
            String contentType = file.getContentType();
            if (contentType == null) {
                throw new RuntimeException("Не удалось определить тип файла");
            }
            
            // Генерируем уникальное имя файла
            String originalFileName = file.getOriginalFilename();
            String fileExtension = "";
            if (originalFileName != null && originalFileName.contains(".")) {
                fileExtension = originalFileName.substring(originalFileName.lastIndexOf("."));
            }
            
            String fileName = UUID.randomUUID().toString() + fileExtension;
            Path filePath = uploadPath.resolve(fileName);
            
            // Сохраняем файл
            Files.copy(file.getInputStream(), filePath, StandardCopyOption.REPLACE_EXISTING);
            
            String fileUrl = "/uploads/" + fileName;
            log.info("Файл сохранен: {}", filePath);
            
            return fileUrl;
            
        } catch (IOException e) {
            log.error("Ошибка при сохранении файла: {}", e.getMessage());
            throw new RuntimeException("Не удалось сохранить файл: " + e.getMessage());
        }
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\service\ModeService.java 
================================================== 
 
package com.example.demo.service;

import com.example.demo.model.ModeSettings;
import com.example.demo.repository.ModeSettingsRepository;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.Map;

@Service
@RequiredArgsConstructor
public class ModeService {
    
    private final ModeSettingsRepository modeSettingsRepository;
    private final AutomationService automationService;
    
    public void applyMode(String modeName) {
        ModeSettings settings = modeSettingsRepository.findByModeName(modeName);
        if (settings == null) {
            settings = createMode(modeName);
        }
        
        // Применяем настройки режима
        switch (modeName) {
            case "eco":
                applyEcoMode(settings);
                break;
            case "comfort":
                applyComfortMode(settings);
                break;
            case "party":
                applyPartyMode(settings);
                break;
            default:
                applyAutoMode(settings);
        }
    }
    
    private void applyEcoMode(ModeSettings settings) {
        // Экономим энергию
        settings.setTargetTemperature(20.0);
        settings.setAutoLightControl(false);
        settings.setAutoEntertainment(false);
        modeSettingsRepository.save(settings);
    }
    
    private void applyComfortMode(ModeSettings settings) {
        // Максимальный комфорт
        settings.setTargetTemperature(24.0);
        settings.setAutoLightControl(true);
        settings.setAutoEntertainment(true);
        modeSettingsRepository.save(settings);
    }
    
    private void applyPartyMode(ModeSettings settings) {
        // Вечеринка - яркий свет, музыка
        settings.setTargetTemperature(22.0);
        settings.setAutoLightControl(true);
        settings.setAutoEntertainment(true);
        modeSettingsRepository.save(settings);
    }
    
    private void applyAutoMode(ModeSettings settings) {
        // Стандартная автоматизация
        settings.setTargetTemperature(22.0);
        settings.setAutoLightControl(true);
        settings.setAutoEntertainment(false);
        modeSettingsRepository.save(settings);
    }
    
    private ModeSettings createMode(String modeName) {
        ModeSettings mode = new ModeSettings();
        mode.setModeName(modeName);
        return modeSettingsRepository.save(mode);
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\service\ProductService.java 
================================================== 
 
package com.example.demo.service;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.concurrent.atomic.AtomicLong;

import org.springframework.stereotype.Service;

import com.example.demo.model.Product;
import com.example.demo.repository.ProductRepository;

import jakarta.annotation.PostConstruct;

@Service
public class ProductService {
    // private List<Product> products=new ArrayList<>(Arrays.asList(new Product(1, "Индийский чай", 130)));
    // private AtomicLong idGeneration = new AtomicLong(1l);
    private final ProductRepository productRepository;
    public ProductService(ProductRepository productRepository) {
        this.productRepository = productRepository;
    }

    public Product create(Product product){
        // Long id = idGeneration.getAndIncrement();
        // product.setId(id);
        // products.add(product);
        // return product;
        return productRepository.save(product);
    }

    public Product getById(Long id) {
        return productRepository.findById(id).orElse(null);
    }

    public List<Product> getByTitle(String title){
        return productRepository.findByTitleStartingWithIgnoreCase(title);
    }

    public Product update(Long id, Product product){
        return productRepository.findById(id).map(existing -> {
            existing.setTitle(product.getTitle());
            existing.setCost(product.getCost());
            return productRepository.save(existing);
        }).orElse(null);
    }

    public boolean deleteById(Long id){
        if(productRepository.existsById(id)){
            productRepository.deleteById(id);
            return true;
        }
        return false;
    }

    public List<Product> getAll(){
        return productRepository.findAll();
    }

    @PostConstruct
    public void init(){
        // create(new Product(null, "Кефир", 123));
    }
}

 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\service\SmartHomeService.java 
================================================== 
 
package com.example.demo.service;

import com.example.demo.model.*;
import com.example.demo.repository.*;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

@Slf4j
@Service
@RequiredArgsConstructor
public class SmartHomeService {
    
    private final RoomRepository roomRepository;
    private final DeviceRepository deviceRepository;
    private final DeviceDataRepository deviceDataRepository;
    private final ModeSettingsRepository modeSettingsRepository;
    private final AutomationService automationService;
    
    public RoomStatus getRoomStatus(Long roomId) {
        log.debug("Getting room status for roomId: {}", roomId);
        
        Room room = roomRepository.findById(roomId)
            .orElseThrow(() -> {
                log.error("Room not found with id: {}", roomId);
                return new RuntimeException("Room not found");
            });
        
        RoomStatus status = new RoomStatus();
        status.setRoomId(roomId);
        status.setRoomName(room.getName());
        
        List<Device> devices = deviceRepository.findByRoomId(roomId);
        log.debug("Found {} devices for room: {}", devices.size(), room.getName());
        
        for (Device device : devices) {
            if (device.getType().name().contains("SENSOR")) {
                DeviceData latestData = deviceDataRepository.findTopByDeviceIdOrderByTimestampDesc(device.getId());
                if (latestData != null) {
                    status.getSensorData().put(device.getType().name(), latestData.getValue());
                    log.trace("Sensor data for {}: {}", device.getName(), latestData.getValue());
                }
            }
            
            Map<String, Object> deviceStatus = new HashMap<>();
            deviceStatus.put("online", device.isOnline());
            deviceStatus.put("lastValue", device.getLastValue());
            deviceStatus.put("type", device.getType());
            
            status.getDeviceStatus().put(device.getName(), deviceStatus);
        }
        
        status.setOccupied(detectRoomOccupancy(status));
        status.setCurrentMode(getCurrentMode().getModeName());
        
        log.info("Room status retrieved for {}: {} devices, occupied: {}", 
                 room.getName(), devices.size(), status.isOccupied());
        return status;
    }
    
    public void processDeviceData(String deviceId, Double value, String dataType) {
        log.info("Processing device data - Device: {}, Value: {}, Type: {}", deviceId, value, dataType);
        
        Device device = deviceRepository.findByDeviceId(deviceId);
        if (device == null) {
            log.error("Device not found: {}", deviceId);
            throw new RuntimeException("Device not found: " + deviceId);
        }
        
        DeviceData deviceData = new DeviceData();
        deviceData.setDevice(device);
        deviceData.setValue(value);
        deviceData.setDataType(dataType);
        deviceData.setTimestamp(LocalDateTime.now());
        deviceDataRepository.save(deviceData);
        
        device.setLastValue(value);
        device.setOnline(true);
        deviceRepository.save(device);
        
        log.debug("Device data saved and automation triggered for: {}", device.getName());
        automationService.processAutomation(device, value);
    }
    
    public ModeSettings updateModeSettings(ModeSettings settings) {
        log.info("Updating mode settings to: {}", settings.getModeName());
        ModeSettings updated = modeSettingsRepository.save(settings);
        log.debug("Mode settings updated: {}", updated);
        return updated;
    }
    
    public ModeSettings getCurrentMode() {
        List<ModeSettings> allModes = modeSettingsRepository.findAll();
        if (!allModes.isEmpty()) {
            log.debug("Current mode: {}", allModes.get(0).getModeName());
            return allModes.get(0);
        }
        
        log.info("No modes found, creating default mode");
        return createDefaultMode();
    }
    
    private ModeSettings createDefaultMode() {
        ModeSettings defaultMode = new ModeSettings();
        defaultMode.setModeName("auto");
        defaultMode.setTargetTemperature(22.0);
        defaultMode.setTemperatureThreshold(1.0);
        defaultMode.setAutoLightControl(true);
        defaultMode.setAutoEntertainment(false);
        defaultMode.setTargetLightLevel(300);
        
        log.info("Created default mode: auto");
        return modeSettingsRepository.save(defaultMode);
    }
    
    private boolean detectRoomOccupancy(RoomStatus status) {
        Double lightLevel = status.getSensorData().get("LIGHT_SENSOR");
        boolean occupied = lightLevel != null && lightLevel < 50;
        log.trace("Room occupancy detection - lightLevel: {}, occupied: {}", lightLevel, occupied);
        return occupied;
    }

    public Map<String, Object> getAutomationStats() {
        log.debug("Generating automation statistics");
        
        Map<String, Object> stats = new HashMap<>();
        
        long totalDevices = deviceRepository.count();
        long onlineDevices = deviceRepository.findAll().stream()
                .filter(Device::isOnline)
                .count();
        
        stats.put("totalDevices", totalDevices);
        stats.put("onlineDevices", onlineDevices);
        stats.put("onlinePercentage", (onlineDevices * 100) / totalDevices);
        
        List<Device> activeDevices = deviceRepository.findAll().stream()
                .filter(d -> d.getLastValue() != null && d.getLastValue() > 0)
                .collect(Collectors.toList());
        
        stats.put("activeDevices", activeDevices.size());
        stats.put("energySaving", calculateEnergySaving());
        
        log.info("Automation stats - Total: {}, Online: {}, Active: {}", 
                 totalDevices, onlineDevices, activeDevices.size());
        return stats;
    }

    private String calculateEnergySaving() {
        return "15%";
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\service\UserDetailServiceImpl.java 
================================================== 
 
package com.example.demo.service;

import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.repository.UserRepository;
import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class UserDetailServiceImpl implements UserDetailsService{

    private final UserRepository userRepository;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        // TODO Auto-generated method stub
        // throw new UnsupportedOperationException("Unimplemented method 'loadUserByUsername'");
        return userRepository.findByUsername(username)
        .orElseThrow(() -> new ResourceNotFoundException("User not found"));
    }
    
}
 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\main\java\com\example\demo\service\UserService.java 
================================================== 
 
package com.example.demo.service;

import java.util.List;

import javax.management.relation.RoleNotFoundException;

import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;

import com.example.demo.dto.ChangePasswordRequest;
import com.example.demo.dto.UserDto;
import com.example.demo.exception.ResourceNotFoundException;
import com.example.demo.mapper.UserMapper;
import com.example.demo.model.User;
import com.example.demo.repository.RoleRepository;
import com.example.demo.repository.UserRepository;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class UserService {
    private final UserRepository userRepository;
    private final RoleRepository roleRepository;
    private final PasswordEncoder passwordEncoder;

    public List<UserDto> getUsers(){
        return userRepository.findAll().stream().map(UserMapper::userToUserDto).toList();
    }
    
    public User getByUsername(String username){
        User user = userRepository.findByUsername(username)
            .orElseThrow(() -> new ResourceNotFoundException("user not found with username" + username));
        return user;
    }
    
    public void changePassword(ChangePasswordRequest request) {
        // Получаем текущего пользователя из SecurityContext
        String currentUsername = getCurrentUsername();
        User user = getByUsername(currentUsername);
        
        // Проверяем текущий пароль
        if (!passwordEncoder.matches(request.currentPassword(), user.getPassword())) {
            throw new RuntimeException("Текущий пароль неверен");
        }
        
        // Проверяем совпадение нового пароля и подтверждения
        if (!request.newPassword().equals(request.confirmPassword())) {
            throw new RuntimeException("Новый пароль и подтверждение не совпадают");
        }
        
        // Обновляем пароль
        user.setPassword(passwordEncoder.encode(request.newPassword()));
        userRepository.save(user);
    }
    
    private String getCurrentUsername() {
        // В реальном приложении получаем из SecurityContext
        // Здесь упрощенная реализация - нужно интегрировать с JWT
        return org.springframework.security.core.context.SecurityContextHolder
            .getContext().getAuthentication().getName();
    }
} 
 
================================================== 
ФАЙЛ: E:\My Project\Java_programming\src\test\java\com\example\demo\DemoApplicationTests.java 
================================================== 
 
package com.example.demo;

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

@SpringBootTest
class DemoApplicationTests {

	@Test
	void contextLoads() {
	}

}
 
 
================================================== 
ИТОГО: 
Обработано файлов: 54 
Всего строк кода: 0 
================================================== 
